// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("PRISMA_DATABASE_URL") // プーリング接続用
  directUrl = env("POSTGRES_URL") // マイグレーション用(直接接続)
}

// --------------------------------------
// 1. 認証関連 (NextAuth.js推奨のモデル)
// --------------------------------------

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  accounts      Account[]
  sessions      Session[]
  
  // アプリケーション固有のリレーション
  decks         Deck[]    // ユーザーが作成した単語帳リスト
  
  // クラスルーム関連
  createdClassrooms Classroom[] @relation("Teacher") // 先生として作ったクラス
  joinedClassrooms  Classroom[] @relation("Student") // 生徒として参加したクラス
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// --------------------------------------
// 2. 単語帳アプリのメイン機能
// --------------------------------------

model Deck {
  id          String    @id @default(cuid())
  title       String
  description String?
  isPublic    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  sections    Section[] // 保持しているSection
  classrooms  Classroom[] // 単語帳が所属しているクラスルーム
}

// 新規追加: セクションモデル
model Section {
  id        String   @id @default(cuid())
  name      String   // セクション名
  createdAt DateTime @default(now())

  deckId    String
  deck      Deck     @relation(fields: [deckId], references: [id], onDelete: Cascade)

  cards     Card[]   // SectionがCardを持つ
}

model Card {
  id          String   @id @default(cuid())
  term        String
  definition  String
  createdAt   DateTime @default(now())

  // 所属しているSectionId
  sectionId   String
  section     Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
}

// クラスルームモデル
model Classroom {
  id          String   @id @default(cuid())
  name        String   // クラス名 (例: "1年A組 英語")
  code        String   @unique // 参加用コード (例: "XKY789")
  createdAt   DateTime @default(now())

  // 先生 (作成者)
  teacherId   String
  teacher     User     @relation("Teacher", fields: [teacherId], references: [id], onDelete: Cascade)

  // 生徒たち (多対多)
  students    User[]   @relation("Student")

  // 追加された単語帳 (多対多)
  decks       Deck[]
}